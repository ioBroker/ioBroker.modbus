# ioBroker.modbus Adapter

ioBroker.modbus is a Node.js adapter that implements ModBus Slave and Master functionality for the ioBroker home automation platform. It includes a React-based admin interface and comprehensive ModBus protocol support.

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Working Effectively

### Bootstrap, build, and test the repository:
- `npm install` -- Install root dependencies (takes ~20 seconds)
- `npm run build` -- Build the React admin interface. NEVER CANCEL: takes ~40 seconds. Set timeout to 120+ seconds.
- `npm run lint` -- Lint all code (takes ~5 seconds)  
- `npm test` -- Run full test suite. NEVER CANCEL: takes ~60 seconds. Set timeout to 180+ seconds.

### Build Process Details:
The build process consists of multiple steps executed by `npm run build`:
1. Installs frontend dependencies in `src/` directory
2. Builds React admin interface using Vite
3. Copies build artifacts to `admin/` directory
4. Patches HTML files for ioBroker integration

You can run individual build steps:
- `npm run 0-clean` -- Clean admin directory
- `npm run 1-npm` -- Install frontend dependencies only
- `npm run 2-build` -- Build React app only  
- `npm run 3-copy` -- Copy build artifacts only
- `npm run 4-patch` -- Patch HTML files only

### Development Dependencies:
- Node.js >=16 (specified in package.json engines)
- All dependencies are installed via npm (no additional setup required)

## Validation

### Always run these validation steps after making changes:
1. `npm run lint` -- ESLint with TypeScript support (must pass)
2. `npm run build` -- Full build process (must complete successfully)  
3. `npm test` -- Complete test suite including adapter tests

### Build Artifacts:
After successful build, check that these files exist in `admin/`:
- `admin/index_m.html` -- Main admin interface
- `admin/assets/` -- JavaScript and CSS bundles
- `admin/modbus.png` -- Adapter icon

### Testing Infrastructure:
The test directory contains ModBus simulators for testing:
- `test/Ananas32.zip` / `test/Ananas64.zip` -- Slave simulators (holding registers and inputs)
- `test/RMMS.zip` -- Master simulator
- `test/mod_RSsim.exe` -- Slave simulator (requires Visual C++ 2008 SP1 Redistributable on Windows)

## Project Structure

### Key directories and files:
```
.
├── admin/                 -- Built admin interface (generated by build)
├── lib/                   -- Core adapter logic
│   ├── Master.ts         -- ModBus master implementation
│   ├── Slave.ts          -- ModBus slave implementation  
│   ├── common.ts         -- Shared utilities
│   └── jsmodbus/         -- Custom ModBus protocol implementation
├── src/                  -- React admin interface source
│   ├── package.json      -- Frontend dependencies
│   └── build/            -- Vite build output (generated)
├── test/                 -- Test suite and ModBus simulators
├── main.ts               -- Adapter entry point
├── io-package.json       -- ioBroker adapter metadata
├── package.json          -- Node.js dependencies and scripts
├── tasks.js              -- Custom build script
├── tsconfig.json         -- TypeScript configuration
└── eslint.config.mjs     -- ESLint configuration
```

### Dependencies:
- Core: `@iobroker/adapter-core`, `serialport` (optional)
- Build: `@iobroker/build-tools`, `vite`
- Testing: `mocha`, `chai`, `@iobroker/testing`

## Common Tasks

### Adding ModBus functionality:
- Modify `lib/Master.ts` for master mode features
- Modify `lib/Slave.ts` for slave mode features  
- Update `lib/common.ts` for shared utilities
- Admin UI changes go in `src/` directory

### Debugging ModBus communication:
- Use test simulators in `test/` directory
- Enable debug logging in adapter configuration
- Check serial port availability with `listUart` command

### Release process:
- `npm run release-patch` -- Patch version release
- `npm run release-minor` -- Minor version release  
- `npm run release-major` -- Major version release

## Configuration

### ESLint:
- Uses `@iobroker/eslint-config` with TypeScript support
- Ignores: `src/`, `admin/`, `test/`, `node_modules/`, `build/`
- Custom rule overrides in `eslint.config.mjs`

### TypeScript:
- Configuration in `tsconfig.json` for type checking only
- Checks `main.ts` and `lib/**/*.js` files
- No compilation output (just type checking)

### Build system:
- Custom build script in `tasks.js`
- Uses `@iobroker/build-tools` for React compilation
- Vite-based build system for modern React features

## CI/CD Pipeline

The GitHub workflow (`.github/workflows/test-and-release.yml`) runs:
1. Lint and package checks (quick validation)
2. Adapter tests on multiple Node.js versions (18.x, 20.x, 22.x) and OSes
3. Automated release to npm on tagged commits

### Build times on CI:
- Lint: ~5 seconds
- Build: ~40 seconds  
- Tests: ~60 seconds per Node.js version/OS combination

## Troubleshooting

### Common issues:
- **Serial port not available**: Install `serialport` dependency or disable serial features
- **Build fails**: Ensure all dependencies installed with `npm install` in both root and `src/`
- **Tests fail**: Check that no other ioBroker instance is running
- **Admin UI not loading**: Verify build artifacts exist in `admin/` directory

### Performance considerations:
- ModBus polling intervals can be configured per device
- Memory usage scales with number of configured registers  
- Serial communication may have timing constraints

Always run `npm run lint` and `npm test` before submitting changes to ensure CI compatibility.